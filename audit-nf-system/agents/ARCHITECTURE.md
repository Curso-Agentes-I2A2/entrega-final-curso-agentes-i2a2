# üèóÔ∏è ARQUITETURA DO SISTEMA

Documenta√ß√£o t√©cnica da arquitetura do sistema de auditoria de NF-e.

---

## üìê Vis√£o Geral

O sistema segue uma arquitetura de **Multi-Agent System** com orquestra√ß√£o centralizada:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      FastAPI Layer                          ‚îÇ
‚îÇ  - REST API endpoints                                       ‚îÇ
‚îÇ  - Request/Response handling                                ‚îÇ
‚îÇ  - WebSocket support                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Orchestration Layer                         ‚îÇ
‚îÇ              AgentCoordinator                               ‚îÇ
‚îÇ  - Manages agent workflow                                   ‚îÇ
‚îÇ  - Consolidates results                                     ‚îÇ
‚îÇ  - Makes final decisions                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                      ‚îÇ
       ‚ñº                                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ValidationAgent  ‚îÇ              ‚îÇ    AuditAgent           ‚îÇ
‚îÇ                  ‚îÇ              ‚îÇ                         ‚îÇ
‚îÇ - Schema check   ‚îÇ              ‚îÇ - Fiscal rules          ‚îÇ
‚îÇ - Format val.    ‚îÇ              ‚îÇ - Tax calculations      ‚îÇ
‚îÇ - Field presence ‚îÇ              ‚îÇ - CFOP validation       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                               ‚îÇ
         ‚îÇ                               ‚îú‚îÄ‚îÄ‚ñ∫ RAGTool
         ‚îÇ                               ‚îú‚îÄ‚îÄ‚ñ∫ TaxCalculator
         ‚îÇ                               ‚îî‚îÄ‚îÄ‚ñ∫ RulesEngine
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     External Services                        ‚îÇ
‚îÇ  - RAG Service (Knowledge Base)                             ‚îÇ
‚îÇ  - MCP (if available)                                       ‚îÇ
‚îÇ  - SEFAZ APIs (mock in dev)                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß© Componentes Principais

### 1. FastAPI Application (`main.py`)

**Responsabilidade:** 
- Ponto de entrada da aplica√ß√£o
- Gerenciamento do ciclo de vida (startup/shutdown)
- Middleware (CORS, logging)
- Exception handling global

**Principais Rotas:**
- `GET /` - Root endpoint
- `GET /health` - Health check
- `GET /docs` - Swagger UI
- `WS /ws/stream` - WebSocket para streaming

### 2. Configuration (`config.py`)

**Responsabilidade:**
- Gerenciar todas as configura√ß√µes via vari√°veis de ambiente
- Validar configura√ß√µes no startup
- Fornecer constantes para todo o sistema

**Configura√ß√µes:**
- API Keys (Anthropic, OpenAI)
- URLs de servi√ßos externos
- Par√¢metros dos modelos (temperature, max_tokens)
- Configura√ß√µes dos agentes
- Timeouts e retry logic

### 3. Agent Coordinator (`orchestrator/coordinator.py`)

**Responsabilidade:**
- Orquestrar fluxo de trabalho entre agentes
- Tomar decis√£o final baseada em m√∫ltiplas valida√ß√µes
- Consolidar resultados

**Fluxo de Processamento:**
```python
1. Recebe invoice_data
2. Chama ValidationAgent
   ‚îî‚îÄ‚ñ∫ Se inv√°lido ‚Üí Retorna REPROVADA
3. Chama AuditAgent
   ‚îî‚îÄ‚ñ∫ Se reprovado ‚Üí Retorna REPROVADA
4. Verifica threshold de confian√ßa
5. Retorna decis√£o final consolidada
```

---

## ü§ñ Agentes

### ValidationAgent (`validation_agent/agent.py`)

**Papel:** Validador estrutural e t√©cnico

**Valida√ß√µes Realizadas:**
- ‚úÖ Campos obrigat√≥rios presentes
- ‚úÖ Formato de CNPJ/CPF (14/11 d√≠gitos)
- ‚úÖ Formato de data (YYYY-MM-DD)
- ‚úÖ Formato de CFOP (4 d√≠gitos)
- ‚úÖ Valores num√©ricos v√°lidos
- ‚úÖ Chave de acesso (44 d√≠gitos + DV)
- ‚úÖ Schema XML (se fornecido)
- ‚úÖ Assinatura digital (mock)

**Tecnologia:**
- LangChain + Claude (temperature=0.0 para determinismo)
- Valida√ß√µes algor√≠tmicas (regex, c√°lculos)

**Output:**
```json
{
  "valid": true,
  "errors": [],
  "warnings": [],
  "details": {...}
}
```

### AuditAgent (`audit_agent/agent.py`)

**Papel:** Auditor fiscal especializado

**Valida√ß√µes Realizadas:**
- ‚úÖ CNPJ/CPF v√°lidos (d√≠gitos verificadores)
- ‚úÖ CFOP existe e √© compat√≠vel com opera√ß√£o
- ‚úÖ C√°lculo de ICMS correto
- ‚úÖ C√°lculo de IPI correto
- ‚úÖ C√°lculo de PIS/COFINS correto
- ‚úÖ Consist√™ncia de valores totais
- ‚úÖ Data de emiss√£o v√°lida
- ‚úÖ Detec√ß√£o de duplicidade
- ‚úÖ An√°lise de risco/fraude

**Tecnologia:**
- LangChain Agent Executor
- Claude Sonnet (temperature=0.1)
- RulesEngine (valida√ß√µes r√°pidas)
- RAGTool (consultas √† legisla√ß√£o)
- TaxCalculatorTool (c√°lculos complexos)

**Process Flow:**
```
1. Valida√ß√µes r√°pidas (RulesEngine)
   ‚îî‚îÄ‚ñ∫ Se viola√ß√£o cr√≠tica ‚Üí Rejei√ß√£o imediata
   
2. An√°lise com LLM
   ‚îú‚îÄ‚ñ∫ Consulta RAG se necess√°rio
   ‚îú‚îÄ‚ñ∫ Calcula impostos
   ‚îî‚îÄ‚ñ∫ Racioc√≠nio sobre irregularidades
   
3. Consolida√ß√£o
   ‚îî‚îÄ‚ñ∫ Decis√£o + Confian√ßa + Justificativa
```

**Output:**
```json
{
  "aprovada": true/false,
  "irregularidades": [],
  "confianca": 0.0-1.0,
  "justificativa": "...",
  "detalhes": {...}
}
```

### SyntheticAgent (`synthetic_agent/nf_generator.py`)

**Papel:** Gerador de notas fiscais sint√©ticas

**Funcionalidades:**
- Gerar CNPJ v√°lido com d√≠gitos verificadores
- Gerar chave de acesso v√°lida (44 d√≠gitos + DV)
- Criar notas v√°lidas para testes
- Criar notas inv√°lidas com erros espec√≠ficos
- Criar notas suspeitas (padr√µes anormais)

**Tipos de Notas:**
- `valida`: Completamente conforme
- `invalida`: Com erros propositais (CFOP, ICMS, etc)
- `suspeita`: V√°lida mas com padr√µes suspeitos

---

## üõ†Ô∏è Tools (LangChain)

### RAGTool (`tools/rag_tool.py`)

**Fun√ß√£o:** Consultar base de conhecimento sobre legisla√ß√£o fiscal

**Quando Usar:**
- D√∫vidas sobre al√≠quotas espec√≠ficas
- Confirma√ß√£o de isen√ß√µes/redu√ß√µes
- Interpreta√ß√£o de regras complexas
- Embasamento legal

**Implementa√ß√£o:**
```python
class RAGTool(BaseTool):
    name = "consult_rag"
    
    async def _arun(self, query: str) -> str:
        # Consulta servi√ßo RAG via HTTP
        # Retorna contexto relevante
```

**Mock Mode:**
- Retorna respostas simuladas quando `MOCK_EXTERNAL_SERVICES=True`
- √ötil para desenvolvimento sem depend√™ncias externas

### TaxCalculatorTool (`tools/calculator_tool.py`)

**Fun√ß√£o:** Calcular impostos brasileiros

**Impostos Calculados:**
- ICMS (18% padr√£o SP, 7% reduzida, 12% espec√≠fica)
- IPI (varia por NCM, 10% t√≠pico)
- PIS (0.65% cumulativo, 1.65% n√£o-cumulativo)
- COFINS (3% cumulativo, 7.6% n√£o-cumulativo)

**Input:**
```json
{
  "base_value": 1000.00,
  "state": "SP",
  "tax_regime": "nao_cumulativo",
  "product_type": "normal"
}
```

**Output:**
```json
{
  "icms": {"aliquota": 18.0, "valor": 180.00},
  "ipi": {"aliquota": 10.0, "valor": 100.00},
  "pis": {"aliquota": 1.65, "valor": 16.50},
  "cofins": {"aliquota": 7.6, "valor": 76.00},
  "total_taxes": 372.50
}
```

---

## üéØ Rules Engine (`audit_agent/rules_engine.py`)

**Fun√ß√£o:** Valida√ß√µes determin√≠sticas r√°pidas

**Vantagens:**
- Muito r√°pido (n√£o requer LLM)
- Determin√≠stico (sempre mesmo resultado)
- Sem custo de API
- Detecta erros √≥bvios antes da an√°lise com LLM

**Regras Implementadas:**
- Valida√ß√£o de CNPJ (d√≠gitos verificadores)
- Valida√ß√£o de CFOP (exist√™ncia e compatibilidade)
- C√°lculo de ICMS com toler√¢ncia
- Consist√™ncia de valores totais
- Valida√ß√£o de datas

**Uso:**
```python
engine = RulesEngine()

# Validar CNPJ
valid = engine.validate_cnpj("12345678000190")

# Verificar CFOP
valid = engine.check_cfop("5102", "venda")

# Validar ICMS
errors = engine.check_icms(invoice_data)
```

---

## üì° API Routes (`api/routes.py`)

### Endpoints Dispon√≠veis:

#### POST /api/v1/audit
Auditar nota fiscal completa

**Request:**
```json
{
  "invoice": {...},
  "context": {...}
}
```

**Response:**
```json
{
  "aprovada": true,
  "irregularidades": [],
  "confianca": 0.95,
  "justificativa": "...",
  "detalhes": {...}
}
```

#### POST /api/v1/validate
Validar apenas estrutura (sem auditoria fiscal)

#### POST /api/v1/generate
Gerar nota fiscal sint√©tica

**Request:**
```json
{
  "tipo": "valida",
  "valor_max": 10000.0,
  "estado": "SP"
}
```

#### POST /api/v1/audit/batch
Auditar m√∫ltiplas notas em lote

#### GET /api/v1/agents/health
Health check dos agentes

---

## üîÑ Fluxo de Dados

### Auditoria Completa:

```
1. Cliente ‚Üí POST /api/v1/audit
   ‚îî‚îÄ‚ñ∫ invoice_data + context
   
2. API ‚Üí AgentCoordinator.process_invoice()
   
3. Coordinator ‚Üí ValidationAgent.validate_invoice()
   ‚îî‚îÄ‚ñ∫ Valida√ß√µes estruturais
   ‚îî‚îÄ‚ñ∫ Retorna: {valid, errors, warnings}
   
4. Se valid=False:
   ‚îî‚îÄ‚ñ∫ Retorna REPROVADA imediatamente
   
5. Se valid=True:
   ‚îî‚îÄ‚ñ∫ Coordinator ‚Üí AuditAgent.audit_invoice()
   
6. AuditAgent:
   ‚îú‚îÄ‚ñ∫ RulesEngine (valida√ß√µes r√°pidas)
   ‚îú‚îÄ‚ñ∫ LLM Analysis
   ‚îÇ   ‚îú‚îÄ‚ñ∫ RAGTool (se necess√°rio)
   ‚îÇ   ‚îî‚îÄ‚ñ∫ TaxCalculator (se necess√°rio)
   ‚îî‚îÄ‚ñ∫ Consolida resultado
   
7. Coordinator consolida:
   ‚îú‚îÄ‚ñ∫ Valida√ß√£o + Auditoria
   ‚îú‚îÄ‚ñ∫ Verifica confidence threshold
   ‚îî‚îÄ‚ñ∫ Decis√£o final
   
8. API retorna ao cliente:
   ‚îî‚îÄ‚ñ∫ {aprovada, irregularidades, confianca, justificativa}
```

---

## üß† Prompts

### System Prompt (AuditAgent)

Componentes principais:
1. **Defini√ß√£o de Papel:** Auditor fiscal especializado
2. **Legisla√ß√£o Aplic√°vel:** ICMS, IPI, PIS, COFINS, CFOPs
3. **Tools Dispon√≠veis:** consult_rag, calculate_taxes
4. **Processo de Auditoria:** 5 fases de valida√ß√£o
5. **Formato de Resposta:** JSON estruturado
6. **Diretrizes:** O que fazer e n√£o fazer
7. **Exemplos:** Few-shot learning

### Audit Template

Template usado para cada auditoria:
- Dados da nota fiscal
- Contexto adicional
- Viola√ß√µes j√° identificadas
- Instru√ß√µes espec√≠ficas

---

## ‚ö° Performance

### Otimiza√ß√µes Implementadas:

1. **Rules Engine First:**
   - Valida√ß√µes r√°pidas antes do LLM
   - Rejei√ß√£o imediata de erros cr√≠ticos
   - Economia de chamadas de API

2. **Streaming:**
   - Tokens s√£o streamados quando poss√≠vel
   - Feedback em tempo real via WebSocket

3. **Caching:**
   - Decis√µes similares podem ser cacheadas
   - Configur√°vel via `ENABLE_CACHE`

4. **Timeouts:**
   - Configur√°veis por agente
   - Previne travamentos

5. **Retry Logic:**
   - 3 tentativas por padr√£o
   - Backoff exponencial

6. **Fallback LLM:**
   - Se Claude falhar, usa GPT-4
   - Garante disponibilidade

---

## üîê Seguran√ßa

### Boas Pr√°ticas Implementadas:

1. **API Keys:** Nunca hardcoded, sempre via `.env`
2. **Input Validation:** Pydantic models validam todos inputs
3. **Error Handling:** Exceptions tratadas globalmente
4. **Logs:** Todas as opera√ß√µes s√£o logadas
5. **CORS:** Configur√°vel, restrito por padr√£o
6. **Rate Limiting:** Pronto para implementar

---

## üìä Monitoramento

### Logs:

**Estrutura:**
```
timestamp - logger_name - level - message
```

**N√≠veis:**
- DEBUG: Detalhes de execu√ß√£o
- INFO: Opera√ß√µes normais
- WARNING: Situa√ß√µes anormais mas n√£o cr√≠ticas
- ERROR: Erros que precisam aten√ß√£o

**Arquivos:**
- Console: Output em tempo real
- `agents.log`: Arquivo persistente

### M√©tricas (TODO):

- Total de auditorias
- Taxa de aprova√ß√£o
- Tempo m√©dio de processamento
- Uso de tokens (custos)
- Erros por tipo

---

## üöÄ Escalabilidade

### Horizontal Scaling:

O sistema √© stateless e pode escalar horizontalmente:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Load    ‚îÇ
‚îÇ Balancer‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ‚îÄ‚ñ∫ [Instance 1] FastAPI + Agents
     ‚îú‚îÄ‚îÄ‚ñ∫ [Instance 2] FastAPI + Agents
     ‚îî‚îÄ‚îÄ‚ñ∫ [Instance 3] FastAPI + Agents
```

### Async/Await:

- Todas as opera√ß√µes de I/O s√£o ass√≠ncronas
- Permite alta concorr√™ncia
- N√£o bloqueia threads

### Background Jobs:

- Batch processing via background tasks
- Pode usar Celery para jobs pesados

---

## üîß Extensibilidade

### Adicionar Novo Agente:

```python
# 1. Criar agente
class NovoAgente:
    def __init__(self):
        self.llm = ChatAnthropic(...)
    
    async def processar(self, data):
        # L√≥gica do agente
        return resultado

# 2. Registrar no Coordinator
class AgentCoordinator:
    def __init__(self):
        self.novo_agente = NovoAgente()
    
    async def process_invoice(self, data):
        # Incluir no fluxo
        resultado_novo = await self.novo_agente.processar(data)
```

### Adicionar Nova Tool:

```python
from langchain.tools import BaseTool

class NovaTool(BaseTool):
    name = "nova_tool"
    description = "..."
    
    def _run(self, input_str: str) -> str:
        # Implementar l√≥gica
        return resultado
    
    async def _arun(self, input_str: str) -> str:
        return self._run(input_str)
```

---

## üìö Refer√™ncias

- **LangChain:** https://python.langchain.com/
- **FastAPI:** https://fastapi.tiangolo.com/
- **Claude API:** https://docs.anthropic.com/
- **Pydantic:** https://docs.pydantic.dev/

---

**Vers√£o:** 1.0.0  
**√öltima Atualiza√ß√£o:** Outubro 2025
